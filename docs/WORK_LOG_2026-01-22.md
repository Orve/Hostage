# 作業ログ: 2026年1月22日

## 概要

本日は **Visual Decay System（視覚的崩壊システム）** と **5フェーズ誕生シーケンス** の実装を行いました。

---

## 1. Visual Decay System（視覚的崩壊システム）

### 目的
HPが減少するにつれて画面が「汚れていく」「劣化していく」視覚効果を実装し、ユーザーに焦燥感と不快感を与える。

### 実装内容

#### 5段階カラー対応（`StasisChamber.tsx`）

| Stage | HP範囲 | 流体色 | フィルター効果 | オーバーレイ |
|-------|--------|--------|---------------|-------------|
| **Pristine** | 90-100 | エメラルド | 輝かしい、高彩度 | なし |
| **Healthy** | 70-89 | 緑色 | わずかに明るい | なし |
| **Caution** | 40-69 | 黄色 | 彩度低下、暗め | 走査線 |
| **Danger** | 10-39 | 赤色 | ぼかし、セピア、コントラスト | ノイズ + 重いビネット |
| **Critical** | 0-9 | 赤黒 | 激しいぼかし、グレースケール | 赤黒オーバーレイ + 激しいノイズ + 高速明滅 |

#### 追加CSSクラス（`globals.css`）

```css
.decay-scanlines      /* 動く走査線オーバーレイ */
.decay-noise          /* SVGベースのノイズ（外部アセット不要） */
.decay-noise-heavy    /* 赤みを帯びた激しいノイズ */
.decay-vignette-heavy /* 強化されたビネット効果 */
.decay-vignette-extreme /* 赤黒い極端なビネット */
.animate-decay-flicker  /* 不規則な高速明滅（0.5秒周期） */
.animate-decay-pulse    /* 赤黒いパルス効果 */
```

---

## 2. 5フェーズ誕生シーケンス

### 目的
新規ユーザーがペットを作成する際、劇的で没入感のある演出を提供する。

### フェーズ構成

| Phase | 名前 | 処理内容 | 演出 |
|-------|------|----------|------|
| **1. Boot** | システム起動 | BIOSチェック、メモリ確保、ニューラルコア起動 | ターミナルログ表示 |
| **2. Chamber** | 培養液充填 | fillLevel: 0% → 100% | 下から上へ液体が充填される |
| **3. Materialize** | キャラクター出現 | opacity: 0 → 1 | フェードイン + フラッシュ |
| **4. Vitals** | HPカウントアップ | HP: 0 → 100 | 数字が増加していく |
| **5. Complete** | 完了 | 成功メッセージ表示 | ダッシュボードへ遷移 |

### StasisChamber 新規Props

```tsx
fillLevel?: number;           // 0-100: 培養液の充填レベル
characterVisible?: boolean;   // キャラクターの表示状態
characterOpacity?: number;    // キャラクターの透明度 (0-1)
```

---

## 3. バグ修正

### Hydration Mismatch 対応

**問題:** `Math.random()` を使用した気泡生成により、SSRとCSRで異なるHTMLが生成されていた。

**解決策:**
1. シード値ベースの**決定論的な擬似乱数生成器**を実装
2. `isMounted` フラグを使用し、クライアントマウント後のみ気泡を表示

```tsx
// 擬似乱数生成器
const seededRandom = (seed: number) => {
  const x = Math.sin(seed) * 10000;
  return x - Math.floor(x);
};

// クライアントサイドでのみ表示
const [isMounted, setIsMounted] = useState(false);
useEffect(() => { setIsMounted(true); }, []);
```

---

## 4. 変更ファイル一覧

| ファイル | 変更内容 |
|----------|----------|
| `components/StasisChamber.tsx` | 5段階カラー対応、fillLevel/characterVisible props追加、Hydration対応 |
| `components/CreatePetForm.tsx` | 5フェーズ誕生シーケンス実装、birthPhase状態管理 |
| `app/globals.css` | Visual Decay用CSSアニメーション・オーバーレイ追加 |
| `app/api/cron/damage/route.ts` | **[NEW]** Vercel Cron用プロキシエンドポイント |
| `frontend/vercel.json` | **[NEW]** Vercel Cron設定（毎日JST 0:00実行） |
| `app/routers/tasks.py` | `/cron/damage` をPOSTからGETに変更（Vercel対応） |

---

## 5. 動作確認

### デモ用
- URL: `http://localhost:3000/demo/create`
- モード: `mockMode={true}`（APIを呼ばない）

### 本番用
- URL: `http://localhost:3000/`
- 条件: ログイン後、ペットがない状態で自動表示

---

## 6. Vercel Cron 設定

### 構成

```
[Vercel Cron] 
    ↓ GET /api/cron/damage (Next.js API Route)
    ↓ 
[Next.js Proxy] 
    ↓ GET /tasks/cron/damage (X-API-KEY ヘッダー付き)
    ↓
[FastAPI Backend on Railway]
    → 全ユーザーのダメージ計算＆適用
```

### スケジュール
- **Cron式**: `0 15 * * *`
- **UTC**: 15:00
- **JST**: 0:00（深夜）

### ファイル
- `frontend/vercel.json`: Cron設定
- `frontend/app/api/cron/damage/route.ts`: プロキシAPI
- `app/routers/tasks.py`: バックエンドエンドポイント（GET対応）

### 環境変数
| 変数名 | 用途 |
|--------|------|
| `NEXT_PUBLIC_API_URL` | バックエンドURL |
| `CRON_SECRET` | API認証キー |

---

## 7. 次のステップ（TODO）

- [ ] 音響効果の追加（オプション）
- [ ] 誕生シーケンス中のスキップ機能
- [ ] Visual Decayの強度調整オプション
- [ ] モバイル対応の最適化
- [x] Vercel Cron設定

---

## 技術メモ

### CSS Only ノイズ生成
外部画像を使わず、SVGの`feTurbulence`フィルターをdata URIとして埋め込み：
```css
background-image: url("data:image/svg+xml,...");
```

### Framer Motion 活用
- `AnimatePresence` によるマウント/アンマウントアニメーション
- `variants` による状態ベースのアニメーション管理
- `animate` プロパティによる動的アニメーション切り替え

### Vercel Cron の落とし穴
- **Vercel CronはGETリクエストのみ**送信する
- 外部APIを直接呼び出せないため、**Next.js API Routeでプロキシ**が必要
